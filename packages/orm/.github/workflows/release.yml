name: Release

on:
  push:
    tags:
      - 'orm-v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libpq-dev libmysqlclient-dev libsqlite3-dev

    - name: Run tests
      working-directory: packages/orm
      run: cargo test --features full

    - name: Build release
      working-directory: packages/orm
      run: cargo build --release --features full

    - name: Generate changelog
      id: changelog
      run: |
        # Extract version from tag
        VERSION=${GITHUB_REF#refs/tags/orm-v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

        # Generate changelog entry
        echo "## [$VERSION] - $(date +%Y-%m-%d)" >> changelog_entry.md
        echo "" >> changelog_entry.md
        echo "### Added" >> changelog_entry.md
        echo "- Release $VERSION" >> changelog_entry.md
        echo "" >> changelog_entry.md
        echo "### Changed" >> changelog_entry.md
        echo "- Updated dependencies" >> changelog_entry.md

    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Vela ORM ${{ steps.changelog.outputs.version }}
        body_path: changelog_entry.md
        draft: false
        prerelease: false

  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: release
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Publish to crates.io
      working-directory: packages/orm
      run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }}
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [release, publish]
    if: success()
    steps:
    - name: Notify Discord
      uses: Ilshidur/action-discord@master
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      with:
        args: |
          ðŸŽ‰ **Vela ORM ${{ steps.changelog.outputs.version }} Released!**

          ðŸ“¦ Published to crates.io
          ðŸ“š Documentation updated
          ðŸ§ª All tests passing

          Check it out: https://crates.io/crates/vela-orm/${{ steps.changelog.outputs.version }}