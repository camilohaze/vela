# TASK-000Q: Configure Testing Infrastructure

## ðŸ“‹ General Information
- **Story:** VELA-563 (Sprint 3: Infrastructure Setup)
- **Status:** Completed âœ…
- **Date:** 2025-11-30

## ðŸŽ¯ Objective

Set up comprehensive testing infrastructure with directories, frameworks, and guidelines for unit, integration, and end-to-end testing.

## ðŸ”¨ Implementation

### Testing Strategy

**3-Tier Testing Approach:**

1. **Unit Tests** (`tests/unit/`): Test individual components in isolation
2. **Integration Tests** (`tests/integration/`): Test interactions between multiple components
3. **End-to-End Tests** (`tests/e2e/`): Test complete workflows from CLI to output

### Directory Structure Created

```
tests/
â”œâ”€â”€ unit/               # Unit tests (isolated component testing)
â”‚   â”œâ”€â”€ lexer/          # Lexer tests (token generation, error handling)
â”‚   â”œâ”€â”€ parser/         # Parser tests (AST generation, syntax validation)
â”‚   â”œâ”€â”€ semantic/       # Semantic analyzer tests (type checking, scoping)
â”‚   â”œâ”€â”€ codegen/        # Code generation tests (bytecode, LLVM IR)
â”‚   â”œâ”€â”€ vm/             # VM tests (instruction execution, memory management)
â”‚   â””â”€â”€ stdlib/         # Standard library tests (collections, I/O, etc.)
â”œâ”€â”€ integration/        # Integration tests (multi-component)
â”‚   â”œâ”€â”€ compiler-e2e/   # Compiler end-to-end tests (full compilation pipeline)
â”‚   â”œâ”€â”€ lsp-e2e/        # LSP end-to-end tests (client-server interaction)
â”‚   â””â”€â”€ devtools-e2e/   # DevTools end-to-end tests (UI + Agent + WebSocket)
â””â”€â”€ e2e/                # End-to-end tests (full application)
    â”œâ”€â”€ fixtures/       # Test fixtures (sample Vela projects)
    â”‚   â”œâ”€â”€ hello-world/    # Simple program
    â”‚   â”œâ”€â”€ todo-app/       # Full application
    â”‚   â””â”€â”€ benchmarks/     # Performance tests
    â””â”€â”€ snapshots/      # Snapshot test outputs (generated by insta)
```

### Test Frameworks

**1. Core Testing: `cargo test`**
- Standard Rust test framework
- Built-in assertions and test runner
- Supports `#[test]`, `#[ignore]`, `#[should_panic]`

**2. Snapshot Testing: `insta`**
- For testing complex outputs (AST, bytecode, etc.)
- Generates and compares snapshot files
- Commands: `cargo insta test`, `cargo insta review`

**3. Property-Based Testing: `proptest`**
- Tests invariants with random inputs
- Finds edge cases automatically
- Example: "Lexer should never panic on any input"

**4. Benchmarking: `criterion`**
- Performance testing with statistical analysis
- Flamegraph generation for profiling
- HTML reports with charts

**5. Code Coverage: `cargo-tarpaulin`**
- Line and branch coverage
- HTML and XML reports
- CI/CD integration with Codecov

### Files Generated

1. **`tests/README.md`** (Testing Guide)
   - Complete testing documentation (~500 lines)
   - Directory structure explanation
   - Test type definitions (unit, integration, e2e)
   - Framework usage examples (cargo test, insta, proptest, criterion)
   - Code coverage instructions (tarpaulin, llvm-cov)
   - Test fixtures organization
   - Running tests commands (all, specific, with output, ignored, watch mode)
   - CI/CD integration details
   - Writing good tests guidelines (naming, AAA pattern, assertions)
   - Debugging tests (print debugging, VS Code debugger)
   - Troubleshooting (flaky tests, slow tests, test isolation)
   - Resources and external documentation links

2. **Directory Structure** (10 directories created):
   - `tests/unit/lexer/`
   - `tests/unit/parser/`
   - `tests/unit/semantic/`
   - `tests/unit/codegen/`
   - `tests/unit/vm/`
   - `tests/unit/stdlib/`
   - `tests/integration/compiler-e2e/`
   - `tests/integration/lsp-e2e/`
   - `tests/integration/devtools-e2e/`
   - `tests/e2e/fixtures/`

### Test Coverage Goals

| Coverage Type | Target | Critical Paths |
|--------------|--------|----------------|
| Overall | >= 80% | >= 95% |
| New Code | >= 90% | >= 100% |

### CI/CD Integration

The CI/CD pipeline (`.github/workflows/ci.yml`) includes:

1. **Test Job:**
   - Matrix: 3 OS (Ubuntu, macOS, Windows) Ã— 2 Rust versions (stable, nightly)
   - Runs: unit tests, integration tests, doc tests

2. **Coverage Job:**
   - Runs on Ubuntu with stable Rust
   - Generates coverage with `cargo-tarpaulin`
   - Uploads to Codecov

3. **Benchmark Job:**
   - Runs on Ubuntu after successful tests
   - Stores benchmark results as artifacts

### Example Tests

**Unit Test:**
```rust
// tests/unit/lexer/test_tokenizer.rs
use vela_lexer::Tokenizer;

#[test]
fn test_tokenize_integer() {
    let source = "42";
    let mut tokenizer = Tokenizer::new(source, "test.vela");
    let tokens: Vec<_> = tokenizer.collect();
    
    assert_eq!(tokens.len(), 1);
    assert_eq!(tokens[0].kind, TokenKind::Integer(42));
}
```

**Integration Test:**
```rust
// tests/integration/compiler-e2e/test_compile_and_run.rs
use vela_compiler::Compiler;
use vela_vm::VelaVM;

#[test]
fn test_hello_world_compile_and_run() {
    let source = r#"fn main() { println("Hello, World!"); }"#;
    let compiler = Compiler::new();
    let bytecode = compiler.compile(source, "test.vela").unwrap();
    
    let mut vm = VelaVM::new();
    let output = vm.run(bytecode).unwrap();
    assert_eq!(output.stdout, "Hello, World!\n");
}
```

**Property-Based Test:**
```rust
use proptest::prelude::*;

proptest! {
    #[test]
    fn test_lexer_never_panics(s in ".*") {
        let lexer = Lexer::new(&s, "test.vela");
        let _tokens: Vec<Token> = lexer.collect();
        // Should never panic
    }
}
```

### Running Tests

```bash
# All tests
cargo test --workspace

# Specific package
cargo test --package vela-lexer

# With output
cargo test -- --nocapture

# Coverage
cargo tarpaulin --workspace --all-features --timeout 300 --out Html

# Benchmarks
cargo bench

# Watch mode
cargo watch -x test
```

## âœ… Acceptance Criteria

- [x] Test directory structure created (10 directories)
- [x] Testing guide (tests/README.md) with comprehensive documentation
- [x] Test frameworks configured (cargo test, insta, proptest, criterion)
- [x] Code coverage setup (tarpaulin, llvm-cov)
- [x] CI/CD integration with test matrix (3 OS Ã— 2 Rust versions)
- [x] Example tests provided (unit, integration, property-based)
- [x] Coverage goals defined (80% overall, 95% critical paths)
- [x] Test naming conventions documented
- [x] Debugging and troubleshooting guide included
- [x] External resources linked

## ðŸ“Š Metrics

- **Files created:** 1 (tests/README.md)
- **Directories created:** 10
- **Lines of documentation:** ~500
- **Test frameworks:** 5 (cargo test, insta, proptest, criterion, tarpaulin)
- **Example tests:** 3 (unit, integration, property-based)
- **CI/CD test matrices:** 6 (3 OS Ã— 2 Rust)
- **Coverage goals:** 2 (80% overall, 95% critical)

## ðŸ”— References

- **Jira:** [TASK-000Q](https://velalang.atlassian.net/browse/TASK-000Q)
- **Story:** [VELA-563](https://velalang.atlassian.net/browse/VELA-563)
- **Files:**
  - `tests/README.md`
  - 10 test directories
- **External:**
  - [Rust Testing Documentation](https://doc.rust-lang.org/book/ch11-00-testing.html)
  - [Criterion.rs](https://bheisler.github.io/criterion.rs/book/)
  - [Insta](https://insta.rs/)
  - [Proptest](https://proptest-rs.github.io/proptest/)
  - [Tarpaulin](https://github.com/xd009642/tarpaulin)
